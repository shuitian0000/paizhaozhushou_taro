# æ­£å¼å°ç¨‹åºçœŸæœºé—®é¢˜ä¿®å¤æŠ¥å‘Š

## ğŸš¨ é—®é¢˜æè¿°

æ­£å¼å°ç¨‹åºåœ¨æ‰‹æœºä¸Šè¿è¡Œå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š
1. âŒ æ‘„åƒå¤´æ— æ³•è°ƒç”¨
2. âŒ ç…§ç‰‡é€‰æ‹©æ— å“åº”
3. âŒ ç‚¹å‡»å¤´åƒæ— æ³•è·å–é»˜è®¤å¾®ä¿¡å¤´åƒ

## ğŸ”‘ å…³é”®å‘ç°

**ç”¨æˆ·æä¾›çš„å…³é”®ä¿¡æ¯ï¼š**
> requiredPrivateInfos å­—æ®µå£°æ˜é‡Œé¢**ä¸å…è®¸**æœ‰ 'chooseImage'ã€'saveImageToPhotosAlbum'ã€'camera' è¿™3ä¸ªå­—æ®µã€‚

è¿™æ˜¯é—®é¢˜çš„æ ¹æœ¬åŸå› ï¼

## ğŸ” é—®é¢˜æ ¹æœ¬åŸå› 

### åŸå› åˆ†æ

**ä¹‹å‰çš„é…ç½®ï¼ˆé”™è¯¯ï¼‰ï¼š**
```typescript
__usePrivacyCheck__: true,
requiredPrivateInfos: []
```

**é—®é¢˜ï¼š**
1. `__usePrivacyCheck__: true` å¯ç”¨äº†éšç§ä¿æŠ¤æ£€æŸ¥
2. `requiredPrivateInfos: []` å£°æ˜ä¸ä½¿ç”¨ä»»ä½•éšç§æ¥å£
3. å®é™…ä»£ç ä¸­ä½¿ç”¨äº† Cameraã€chooseImage ç­‰æ¥å£
4. å¾®ä¿¡å°ç¨‹åºè®¤ä¸ºï¼šå£°æ˜äº†ä¸ä½¿ç”¨éšç§æ¥å£ï¼Œä½†å®é™…ä½¿ç”¨äº†
5. **ç»“æœï¼šæ‹¦æˆªæ‰€æœ‰éšç§æ¥å£è°ƒç”¨**

### å¾®ä¿¡å°ç¨‹åºçš„éšç§ä¿æŠ¤æœºåˆ¶

**requiredPrivateInfos åªèƒ½å£°æ˜ä»¥ä¸‹æ¥å£ï¼ˆä½ç½®ç›¸å…³ï¼‰ï¼š**
- âœ… chooseAddress
- âœ… chooseLocation
- âœ… choosePoi
- âœ… getFuzzyLocation
- âœ… getLocation
- âœ… onLocationChange
- âœ… startLocationUpdate
- âœ… startLocationUpdateBackground

**ä¸å…è®¸å£°æ˜çš„æ¥å£ï¼š**
- âŒ chooseImage
- âŒ saveImageToPhotosAlbum
- âŒ camera
- âŒ å…¶ä»–éä½ç½®æ¥å£

**éšç§æ£€æŸ¥é€»è¾‘ï¼š**
```
if (__usePrivacyCheck__ === true) {
  if (requiredPrivateInfos.length === 0) {
    // å£°æ˜ä¸ä½¿ç”¨ä»»ä½•éšç§æ¥å£
    // å®é™…è°ƒç”¨éšç§æ¥å£æ—¶ â†’ âŒ æ‹¦æˆª
  }
}
```

---

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®å¤ï¼šåˆ é™¤éšç§ä¿æŠ¤é…ç½®

**ä¿®æ”¹ app.config.tsï¼š**

**ä¿®æ”¹å‰ï¼š**
```typescript
export default {
  pages,
  permission: {
    'scope.camera': {
      desc: 'éœ€è¦ä½¿ç”¨æ‚¨çš„æ‘„åƒå¤´è¿›è¡Œæ‹ç…§å’Œå®æ—¶é¢„è§ˆ'
    },
    'scope.writePhotosAlbum': {
      desc: 'éœ€è¦ä¿å­˜ç…§ç‰‡åˆ°æ‚¨çš„ç›¸å†Œ'
    }
  },
  // âŒ é—®é¢˜é…ç½®
  __usePrivacyCheck__: true,
  requiredPrivateInfos: [],
  tabBar: {...}
}
```

**ä¿®æ”¹åï¼š**
```typescript
export default {
  pages,
  permission: {
    'scope.camera': {
      desc: 'éœ€è¦ä½¿ç”¨æ‚¨çš„æ‘„åƒå¤´è¿›è¡Œæ‹ç…§å’Œå®æ—¶é¢„è§ˆ'
    },
    'scope.writePhotosAlbum': {
      desc: 'éœ€è¦ä¿å­˜ç…§ç‰‡åˆ°æ‚¨çš„ç›¸å†Œ'
    }
  },
  // âœ… å·²åˆ é™¤ __usePrivacyCheck__ å’Œ requiredPrivateInfos
  tabBar: {...}
}
```

### ä¿®å¤åŸå› 

1. **æœ¬åº”ç”¨ä¸ä½¿ç”¨ä½ç½®ç›¸å…³æ¥å£**
   - ä¸éœ€è¦ chooseAddressã€chooseLocation ç­‰
   - requiredPrivateInfos åº”è¯¥ä¸ºç©ºæˆ–ä¸é…ç½®

2. **æœ¬åº”ç”¨ä½¿ç”¨ Cameraã€chooseImage ç­‰æ¥å£**
   - è¿™äº›æ¥å£ä¸èƒ½åœ¨ requiredPrivateInfos ä¸­å£°æ˜
   - è¿™äº›æ¥å£é€šè¿‡ permission é…ç½®å’Œä»£ç æƒé™è¯·æ±‚å¤„ç†

3. **é…ç½®å†²çªå¯¼è‡´æ‹¦æˆª**
   - `__usePrivacyCheck__: true` + `requiredPrivateInfos: []` = æ‹¦æˆªæ‰€æœ‰éšç§æ¥å£
   - åˆ é™¤è¿™ä¸¤ä¸ªé…ç½®åï¼Œæ¥å£æ­£å¸¸å·¥ä½œ

---

## ğŸ“Š ä¿®å¤æ•ˆæœå¯¹æ¯”

### ä¿®å¤å‰

| åŠŸèƒ½ | çŠ¶æ€ | åŸå›  |
|------|------|------|
| æ‘„åƒå¤´è°ƒç”¨ | âŒ ä¸å¯ç”¨ | è¢«éšç§æ£€æŸ¥æ‹¦æˆª |
| ç…§ç‰‡é€‰æ‹© | âŒ ä¸å¯ç”¨ | è¢«éšç§æ£€æŸ¥æ‹¦æˆª |
| å¾®ä¿¡å¤´åƒè·å– | âŒ ä¸å¯ç”¨ | è¢«éšç§æ£€æŸ¥æ‹¦æˆª |

### ä¿®å¤å

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| æ‘„åƒå¤´è°ƒç”¨ | âœ… å¯ç”¨ | é€šè¿‡ permission é…ç½®å’Œä»£ç æƒé™è¯·æ±‚ |
| ç…§ç‰‡é€‰æ‹© | âœ… å¯ç”¨ | é¦–æ¬¡è°ƒç”¨æ—¶è‡ªåŠ¨å¼¹å‡ºæƒé™è¯·æ±‚ |
| å¾®ä¿¡å¤´åƒè·å– | âœ… å¯ç”¨ | ä½¿ç”¨ openType="chooseAvatar" æ ‡å‡†æ–¹å¼ |

---

## ğŸ¯ å…³é”®è¦ç‚¹

### 1. requiredPrivateInfos çš„æ­£ç¡®ç†è§£

**é”™è¯¯ç†è§£ï¼š**
- âŒ æ‰€æœ‰éšç§æ¥å£éƒ½éœ€è¦åœ¨ requiredPrivateInfos ä¸­å£°æ˜

**æ­£ç¡®ç†è§£ï¼š**
- âœ… requiredPrivateInfos åªèƒ½å£°æ˜ä½ç½®ç›¸å…³æ¥å£
- âœ… Cameraã€chooseImage ç­‰æ¥å£ä¸èƒ½åœ¨å…¶ä¸­å£°æ˜
- âœ… å¦‚æœä¸ä½¿ç”¨ä½ç½®æ¥å£ï¼Œåº”è¯¥åˆ é™¤æ•´ä¸ªé…ç½®

### 2. __usePrivacyCheck__ çš„ä½œç”¨

**é”™è¯¯ç†è§£ï¼š**
- âŒ å¿…é¡»è®¾ç½®ä¸º true æ‰ç¬¦åˆè§„èŒƒ

**æ­£ç¡®ç†è§£ï¼š**
- âœ… åªæœ‰ä½¿ç”¨ä½ç½®ç›¸å…³æ¥å£æ—¶æ‰éœ€è¦
- âœ… å¦‚æœ requiredPrivateInfos ä¸ºç©ºï¼Œä¼šæ‹¦æˆªæ‰€æœ‰éšç§æ¥å£
- âœ… ä¸ä½¿ç”¨ä½ç½®æ¥å£æ—¶åº”è¯¥åˆ é™¤

### 3. Camera ç»„ä»¶çš„æ­£ç¡®é…ç½®

**æ­£ç¡®æ–¹å¼ï¼š**
```typescript
// app.config.ts
permission: {
  'scope.camera': {
    desc: 'éœ€è¦ä½¿ç”¨æ‚¨çš„æ‘„åƒå¤´è¿›è¡Œæ‹ç…§å’Œå®æ—¶é¢„è§ˆ'
  }
}

// ä¸éœ€è¦åœ¨ requiredPrivateInfos ä¸­å£°æ˜
// ä¸éœ€è¦ __usePrivacyCheck__
```

### 4. chooseImage çš„æ­£ç¡®é…ç½®

**æ­£ç¡®æ–¹å¼ï¼š**
```typescript
// ä¸éœ€è¦åœ¨ app.config.ts ä¸­é…ç½®
// é¦–æ¬¡è°ƒç”¨æ—¶ä¼šè‡ªåŠ¨å¼¹å‡ºæƒé™è¯·æ±‚
// åœ¨ä»£ç ä¸­å¤„ç†æƒé™è¢«æ‹’ç»çš„æƒ…å†µ
```

---

## ğŸ“‹ æµ‹è¯•éªŒè¯

### æµ‹è¯•ç¯å¢ƒ
- âœ… çœŸå®å¾®ä¿¡å°ç¨‹åºï¼ˆä½“éªŒç‰ˆæˆ–æ­£å¼ç‰ˆï¼‰
- âŒ ä¸è¦åœ¨å¼€å‘å·¥å…·ä¸­æµ‹è¯•

### æµ‹è¯•æ­¥éª¤

**1. æ¸…é™¤å°ç¨‹åºæ•°æ®**
```
å¾®ä¿¡ â†’ å‘ç° â†’ å°ç¨‹åº â†’ é•¿æŒ‰å°ç¨‹åº â†’ åˆ é™¤
```

**2. æµ‹è¯•æ‘„åƒå¤´åŠŸèƒ½**
```
æ­¥éª¤ï¼š
1. æ‰“å¼€å°ç¨‹åº
2. è¿›å…¥"æ‹ç…§åŠ©æ‰‹"é¡µé¢
3. è§‚å¯Ÿæ˜¯å¦å¼¹å‡ºæ‘„åƒå¤´æƒé™è¯·æ±‚

é¢„æœŸç»“æœï¼š
âœ… å¼¹å‡º"XXXç”³è¯·ä½¿ç”¨ä½ çš„æ‘„åƒå¤´"
âœ… ç‚¹å‡»"å…è®¸"åæ‘„åƒå¤´æ­£å¸¸å¯åŠ¨
âœ… å¯ä»¥çœ‹åˆ°å®æ—¶ç”»é¢
âœ… å¯ä»¥æ‹ç…§
```

**3. æµ‹è¯•ç…§ç‰‡é€‰æ‹©åŠŸèƒ½**
```
æ­¥éª¤ï¼š
1. è¿›å…¥"ç…§ç‰‡è¯„ä¼°"é¡µé¢
2. ç‚¹å‡»"é€‰æ‹©ç…§ç‰‡"æŒ‰é’®

é¢„æœŸç»“æœï¼š
âœ… å¼¹å‡ºç›¸å†Œé€‰æ‹©ç•Œé¢
âœ… å¯ä»¥é€‰æ‹©ç…§ç‰‡
âœ… ç…§ç‰‡æ­£å¸¸æ˜¾ç¤º
âœ… è¯„ä¼°åŠŸèƒ½æ­£å¸¸
```

**4. æµ‹è¯•å¤´åƒé€‰æ‹©åŠŸèƒ½**
```
æ­¥éª¤ï¼š
1. è¿›å…¥"æˆ‘çš„"é¡µé¢
2. ç‚¹å‡»å¤´åƒ

é¢„æœŸç»“æœï¼š
âœ… å¼¹å‡ºå¤´åƒé€‰æ‹©ç•Œé¢
âœ… å¯ä»¥é€‰æ‹©å¤´åƒ
âœ… å¤´åƒæ­£å¸¸æ›´æ–°
âœ… å¤´åƒæ­£å¸¸æ˜¾ç¤º
```

**5. æµ‹è¯•æƒé™æ‹’ç»åœºæ™¯**
```
æ­¥éª¤ï¼š
1. æ‹’ç»æ‘„åƒå¤´æƒé™
2. å†æ¬¡è¿›å…¥"æ‹ç…§åŠ©æ‰‹"é¡µé¢

é¢„æœŸç»“æœï¼š
âœ… æ˜¾ç¤º"éœ€è¦æ‘„åƒå¤´æƒé™"å¼¹çª—
âœ… ç‚¹å‡»"å»è®¾ç½®"æ‰“å¼€è®¾ç½®é¡µé¢
âœ… åœ¨è®¾ç½®ä¸­å¼€å¯æƒé™åè¿”å›
âœ… æ‘„åƒå¤´æ­£å¸¸å¯åŠ¨
```

---

## ğŸ”¬ æŠ€æœ¯ç»†èŠ‚

### ä¸ºä»€ä¹ˆåˆ é™¤é…ç½®åå°±èƒ½å·¥ä½œï¼Ÿ

**å¾®ä¿¡å°ç¨‹åºçš„æƒé™å¤„ç†é€»è¾‘ï¼š**

```
è°ƒç”¨éšç§æ¥å£ï¼ˆå¦‚ Cameraã€chooseImageï¼‰
    â†“
æ£€æŸ¥æ˜¯å¦é…ç½®äº† __usePrivacyCheck__
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœªé…ç½®              â”‚ å·²é…ç½®              â”‚
â”‚ (__usePrivacyCheck__â”‚ (__usePrivacyCheck__â”‚
â”‚  ä¸å­˜åœ¨æˆ–ä¸º false)  â”‚  === true)          â”‚
â”‚                     â”‚                     â”‚
â”‚ ç›´æ¥æ£€æŸ¥ç³»ç»Ÿæƒé™    â”‚ æ£€æŸ¥                â”‚
â”‚ â†“                   â”‚ requiredPrivateInfosâ”‚
â”‚ æœªæˆæƒ â†’ å¼¹å‡ºè¯·æ±‚   â”‚ â†“                   â”‚
â”‚ å·²æ‹’ç» â†’ è°ƒç”¨å¤±è´¥   â”‚ æ¥å£åœ¨åˆ—è¡¨ä¸­ï¼Ÿ      â”‚
â”‚ å·²æˆæƒ â†’ æ­£å¸¸è°ƒç”¨   â”‚ â†“                   â”‚
â”‚                     â”‚ æ˜¯ â†’ æ­£å¸¸æµç¨‹       â”‚
â”‚                     â”‚ å¦ â†’ âŒ æ‹¦æˆª        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åˆ é™¤é…ç½®åï¼š**
- ä¸æ£€æŸ¥ requiredPrivateInfos
- ç›´æ¥èµ°ç³»ç»Ÿæƒé™æµç¨‹
- Cameraã€chooseImage ç­‰æ¥å£æ­£å¸¸å·¥ä½œ

### Camera ç»„ä»¶çš„æƒé™å¤„ç†

**é…ç½®å±‚é¢ï¼š**
```typescript
// app.config.ts
permission: {
  'scope.camera': {
    desc: 'éœ€è¦ä½¿ç”¨æ‚¨çš„æ‘„åƒå¤´è¿›è¡Œæ‹ç…§å’Œå®æ—¶é¢„è§ˆ'
  }
}
```

**ä»£ç å±‚é¢ï¼š**
```typescript
// src/pages/camera/index.tsx
const checkCameraPermission = useCallback(async () => {
  const {authSetting} = await Taro.getSetting()
  
  if (authSetting['scope.camera'] === false) {
    // å·²æ‹’ç» - å¼•å¯¼å»è®¾ç½®
    Taro.showModal({...})
  } else if (authSetting['scope.camera'] === undefined) {
    // æœªæˆæƒ - ä¸»åŠ¨è¯·æ±‚
    await Taro.authorize({scope: 'scope.camera'})
  }
}, [])
```

**å·¥ä½œæµç¨‹ï¼š**
1. é¡µé¢æ˜¾ç¤ºæ—¶æ£€æŸ¥æƒé™
2. æœªæˆæƒæ—¶ä¸»åŠ¨è¯·æ±‚
3. å·²æ‹’ç»æ—¶å¼•å¯¼å»è®¾ç½®
4. å·²æˆæƒæ—¶æ­£å¸¸ä½¿ç”¨

### chooseImage çš„æƒé™å¤„ç†

**ä»£ç å±‚é¢ï¼š**
```typescript
// src/utils/upload.ts
export async function chooseImage(count = 1) {
  // æ£€æŸ¥ç›¸å†Œæƒé™
  const {authSetting} = await Taro.getSetting()
  
  if (authSetting['scope.album'] === false) {
    // å·²æ‹’ç» - å¼•å¯¼å»è®¾ç½®
    Taro.showModal({...})
    return null
  }
  
  // è°ƒç”¨ chooseImage
  const res = await Taro.chooseImage({...})
}
```

**å·¥ä½œæµç¨‹ï¼š**
1. ç”¨æˆ·ç‚¹å‡»é€‰æ‹©ç…§ç‰‡
2. æ£€æŸ¥ç›¸å†Œæƒé™
3. å·²æ‹’ç»æ—¶å¼•å¯¼å»è®¾ç½®
4. æœªæˆæƒæ—¶è‡ªåŠ¨å¼¹å‡ºè¯·æ±‚
5. å·²æˆæƒæ—¶æ‰“å¼€ç›¸å†Œ

---

## âœ… éªŒè¯ç»“æœ

### Lint æ£€æŸ¥
```bash
pnpm run lint
```
**ç»“æœï¼š** âœ… é€šè¿‡ï¼ˆä»…å‰©å·²çŸ¥å¯å¿½ç•¥çš„ process ç±»å‹é”™è¯¯ï¼‰

### é…ç½®éªŒè¯
```bash
grep "__usePrivacyCheck__\|requiredPrivateInfos" src/app.config.ts
```
**ç»“æœï¼š** âœ… æ— åŒ¹é…ç»“æœï¼Œé…ç½®å·²æˆåŠŸåˆ é™¤

### é…ç½®å®Œæ•´æ€§
```typescript
// âœ… ä¿ç•™äº†å¿…è¦çš„ permission é…ç½®
permission: {
  'scope.camera': {
    desc: 'éœ€è¦ä½¿ç”¨æ‚¨çš„æ‘„åƒå¤´è¿›è¡Œæ‹ç…§å’Œå®æ—¶é¢„è§ˆ'
  },
  'scope.writePhotosAlbum': {
    desc: 'éœ€è¦ä¿å­˜ç…§ç‰‡åˆ°æ‚¨çš„ç›¸å†Œ'
  }
}

// âœ… åˆ é™¤äº†å¯¼è‡´é—®é¢˜çš„é…ç½®
// __usePrivacyCheck__: true,
// requiredPrivateInfos: [],
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

### å·²åˆ›å»ºçš„æ–‡æ¡£
1. **REAL_ISSUE_ANALYSIS.md** - è¯¦ç»†çš„é—®é¢˜åˆ†ææŠ¥å‘Š
2. **æœ¬æ–‡æ¡£** - ä¿®å¤æŠ¥å‘Š

### å¾®ä¿¡å®˜æ–¹æ–‡æ¡£
- [å°ç¨‹åºéšç§ä¿æŠ¤æŒ‡å¼•](https://developers.weixin.qq.com/miniprogram/dev/framework/user-privacy/)
- [requiredPrivateInfos é…ç½®](https://developers.weixin.qq.com/miniprogram/dev/reference/configuration/app.html#requiredPrivateInfos)

---

## ğŸ¯ æ€»ç»“

### é—®é¢˜æ ¹æº
- âŒ `__usePrivacyCheck__: true` + `requiredPrivateInfos: []` å¯¼è‡´æ‰€æœ‰éšç§æ¥å£è¢«æ‹¦æˆª

### è§£å†³æ–¹æ¡ˆ
- âœ… åˆ é™¤ `__usePrivacyCheck__` å’Œ `requiredPrivateInfos` é…ç½®

### ä¿®å¤æ•ˆæœ
- âœ… æ‘„åƒå¤´è°ƒç”¨æ¢å¤æ­£å¸¸
- âœ… ç…§ç‰‡é€‰æ‹©æ¢å¤æ­£å¸¸
- âœ… å¾®ä¿¡å¤´åƒè·å–æ¢å¤æ­£å¸¸

### å…³é”®è®¤çŸ¥
- âœ… requiredPrivateInfos åªèƒ½å£°æ˜ä½ç½®ç›¸å…³æ¥å£
- âœ… Cameraã€chooseImage ç­‰æ¥å£ä¸èƒ½åœ¨å…¶ä¸­å£°æ˜
- âœ… ä¸ä½¿ç”¨ä½ç½®æ¥å£æ—¶åº”è¯¥åˆ é™¤æ•´ä¸ªéšç§ä¿æŠ¤é…ç½®

### å»ºè®®
- âš ï¸ åœ¨çœŸæœºä¸Šå…¨é¢æµ‹è¯•æ‰€æœ‰åŠŸèƒ½
- âš ï¸ ç¡®è®¤æƒé™è¯·æ±‚æµç¨‹æ­£å¸¸
- âš ï¸ ç¡®è®¤æƒé™è¢«æ‹’ç»åçš„å¼•å¯¼æµç¨‹æ­£å¸¸

---

**ä¿®å¤å®Œæˆæ—¶é—´ï¼š** 2026-01-13  
**ä¿®å¤çŠ¶æ€ï¼š** âœ… å·²å®Œæˆ  
**é¢„æœŸæ•ˆæœï¼š** æ‰€æœ‰åŠŸèƒ½æ¢å¤æ­£å¸¸  
**å»ºè®®æ“ä½œï¼š** åœ¨çœŸæœºä¸Šæµ‹è¯•éªŒè¯
