# 任务：智能摄影助手微信小程序

## 计划
- [x] 步骤1：读取关键配置文件
- [x] 步骤2：初始化Supabase后端
- [x] 步骤3：设计配色系统
- [x] 步骤4：实现核心功能页面
- [x] 步骤5：实现数据库操作和图片上传
- [x] 步骤6：集成AI分析功能
- [x] 步骤7：配置路由和TabBar
- [x] 步骤8：代码检查和优化
- [x] 步骤9：修复Bug（第一轮）
- [x] 步骤10：实现本地评估算法和修复相机问题（第二轮）
- [x] 步骤11：优化用户体验和添加简略建议（第三轮）
- [x] 步骤12：实现实时预览和评估功能（第四轮）
  - [x] 在upload页面添加返回按钮
  - [x] 改进localEvaluation错误日志
  - [x] 实现实时预览模式（使用Camera组件）
  - [x] 实现每2秒采集镜头并评估
  - [x] 显示实时建议（简短，不超过10字）
  - [x] 支持从实时模式拍摄并保存

## 完成情况
✅ 所有功能已实现完成
✅ 数据库表和存储桶已创建
✅ Edge Function已部署
✅ 所有页面已创建并配置
✅ TabBar图标已下载
✅ 代码检查通过
✅ Bug已修复（第四轮）：
  - upload页面添加了返回按钮
  - localEvaluation添加了详细的错误日志
  - 实现了实时预览和评估功能
  - 支持小程序环境的Camera组件
  - H5环境显示友好提示

## 功能说明

### 拍照助手（实时预览 + 本地评估）

#### 实时预览模式（小程序专属）
- **Camera组件**：使用Taro Camera组件实现实时预览
- **定时采集**：每2秒自动采集一次镜头画面
- **实时评估**：对采集的画面进行本地评估
- **实时建议**：浮层显示简短建议（不超过10字）
  - 构图建议
  - 角度建议
  - 距离建议
  - 光线建议
- **拍摄保存**：点击拍摄按钮保存当前画面

#### H5环境
- 显示友好提示：实时预览功能仅在小程序中可用
- 提供备用方案：调用相机拍照按钮

#### 拍照结果模式
- 显示拍摄的照片
- 完整的评估结果（总分 + 各维度得分）
- 简略建议 + 详细建议
- 可以重新拍照或保存评估结果

### 照片评估（AI评估）
- 选择照片后点击"开始分析"
- 使用文心一言AI分析照片
- **返回按钮**：未选择照片时显示返回按钮
- 评估结果在result页面显示
- 包含简略建议和详细建议

### 历史记录
- 查看所有评估记录
- 按类型筛选（实时拍摄/上传照片）
- 点击记录查看详情

## 实时预览技术实现

### Camera组件
```typescript
<Camera
  className="w-full h-full"
  devicePosition="back"
  flash="off"
  onReady={handleCameraReady}
  style={{width: '100%', height: '100%'}}
/>
```

### 定时采集镜头
```typescript
realtimeTimerRef.current = setInterval(() => {
  if (!cameraCtxRef.current) return

  cameraCtxRef.current.takePhoto({
    quality: 'low',
    success: async (res: any) => {
      // 本地评估
      const result = await evaluatePhotoLocally(res.tempImagePath)
      
      // 生成实时建议
      const suggestions: string[] = []
      if (result.composition_score < 20) {
        suggestions.push('构图：需优化主体位置')
      }
      // ... 其他维度
      
      setRealtimeSuggestions(suggestions)
    }
  })
}, 2000)
```

### 实时建议规则

#### 构图
- < 20分：构图：需优化主体位置
- 20-24分：构图：可调整主体
- ≥ 25分：不显示（良好）

#### 角度
- < 12分：角度：建议换个视角
- 12-15分：角度：可尝试其他角度
- ≥ 16分：不显示（良好）

#### 距离
- < 6分：距离：需调整拍摄距离
- ≥ 6分：不显示（良好）

#### 光线
- < 6分：光线：光线不足
- 6-7分：光线：曝光欠佳
- ≥ 8分：不显示（良好）

### 实时建议显示
- 位置：屏幕顶部，浮层显示
- 样式：黑色半透明背景，白色文字
- 内容：只显示需要改进的维度
- 更新频率：每2秒更新一次

## 环境兼容性

### 小程序环境
- ✅ 实时预览功能
- ✅ Camera组件
- ✅ CameraContext.takePhoto
- ✅ 定时采集和评估
- ✅ 实时建议显示

### H5环境
- ❌ 不支持Camera组件
- ✅ 显示友好提示
- ✅ 提供备用拍照方案
- ✅ 拍照后的评估功能正常

## 错误处理改进

### localEvaluation.ts
- 添加详细的console.log日志
- 记录每个步骤的执行情况
- 图片加载失败时记录路径
- 便于调试和问题定位

### camera页面
- 实时评估失败不影响用户体验
- 拍摄失败显示友好提示
- 环境检测和兼容性处理

## 用户体验优化

### 实时预览模式
1. **即时反馈**
   - 每2秒更新一次建议
   - 只显示需要改进的维度
   - 画面良好时显示"画面良好，可以拍摄"

2. **清晰的视觉层次**
   - 实时建议浮层在顶部
   - 拍摄按钮在底部中央
   - 不遮挡相机预览

3. **流畅的操作流程**
   - 进入页面自动开始实时评估
   - 点击拍摄按钮保存当前画面
   - 自动切换到结果模式

### 照片评估页面
1. **返回按钮**
   - 未选择照片时显示
   - 方便用户返回首页
   - 避免操作死角

## 注意事项
- 实时预览功能仅在微信小程序中可用
- H5环境会显示友好提示并提供备用方案
- 实时评估使用low质量采集，节省性能
- 正式拍摄使用high质量，确保照片质量
- 定时器在页面隐藏时自动停止，避免资源浪费
- 本地评估算法基于图像处理技术，准确度略低于AI
- 评分维度：构图30%、姿态30%、角度20%、距离10%、高度10%



